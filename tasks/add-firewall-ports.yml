---
- name: Extract TCP ports from compose file
  ansible.builtin.shell: |
    set -e -o pipefail
    cd "{{ compose_dir }}/{{ compose_name }}"
    docker compose config 2>/dev/null | \
    yq eval '.services.[].ports[] | select(. != null) | 
      (if type == "string" then . else .published + ":" + .target + "/" + (.protocol // "tcp") end) | 
      select(. | test("/(tcp|$)")) | 
      split(":")[0] | 
      select(. | test("^[0-9]+$"))' - 2>/dev/null | \
    sort -u
  args:
    executable: /bin/bash
  register: compose_tcp_ports
  changed_when: false
  failed_when: false

- name: Extract UDP ports from compose file
  ansible.builtin.shell: |
    set -e -o pipefail
    cd "{{ compose_dir }}/{{ compose_name }}"
    docker compose config 2>/dev/null | \
    yq eval '.services.[].ports[] | select(. != null) | 
      (if type == "string" then . else .published + ":" + .target + "/" + (.protocol // "tcp") end) | 
      select(. | test("/udp")) | 
      split(":")[0] | 
      select(. | test("^[0-9]+$"))' - 2>/dev/null | \
    sort -u
  args:
    executable: /bin/bash
  register: compose_udp_ports
  changed_when: false
  failed_when: false

- name: Add TCP firewall rules for {{ compose_name }}
  ansible.posix.firewalld:
    zone: drop
    port: "{{ item }}/tcp"
    state: enabled
    permanent: true
    immediate: true
  loop: "{{ compose_tcp_ports.stdout_lines }}"
  when: compose_tcp_ports.stdout_lines | length > 0

- name: Add UDP firewall rules for {{ compose_name }}
  ansible.posix.firewalld:
    zone: drop
    port: "{{ item }}/udp"
    state: enabled
    permanent: true
    immediate: true
  loop: "{{ compose_udp_ports.stdout_lines }}"
  when: compose_udp_ports.stdout_lines | length > 0

- name: Store ports for {{ compose_name }} for cleanup tracking
  ansible.builtin.copy:
    dest: /etc/firewalld/compose-ports/{{ compose_name }}.txt
    content: |
      {% for port in compose_tcp_ports.stdout_lines %}
      {{ port }}/tcp
      {% endfor %}
      {% for port in compose_udp_ports.stdout_lines %}
      {{ port }}/udp
      {% endfor %}
    mode: "0644"
  when: (compose_tcp_ports.stdout_lines | length > 0) or (compose_udp_ports.stdout_lines | length > 0)
